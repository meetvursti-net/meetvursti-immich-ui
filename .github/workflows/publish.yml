name: Publish

on:
  # workflow_dispatch:
  # release:
  #   types: [published]
  push:
    branches: [main]

permissions:
  contents: write
  id-token: write
  # packages: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Mise
        uses: immich-app/devtools/actions/use-mise@b868e6e7c8cc212beec876330b4059e661ee44bb # use-mise-action-v1.1.1

      - name: Install
        run: pnpm -r install

      - name: Build
        run: pnpm build

      #      - name: Find package
      #        id: find-package
      #        env:
      #          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
      #        run: |
      #          PACKAGE_NAME="${RELEASE_TAG_NAME%-*}"
      #          echo "Package is $PACKAGE_NAME"
      #          echo "package_name=$PACKAGE_NAME" >> "$GITHUB_OUTPUT"

      # - name: Publish to GitHub Package Registry
      #   # run: pnpm --filter ./packages/${{ steps.find-package.outputs.package_name }} publish --no-git-checks
      #   run: pnpm publish ./packages/ui
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to dist branch
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a temporary directory for the dist branch content
          TEMP_DIR=$(mktemp -d)

          # Copy the built package structure
          cp -r packages/ui/dist "$TEMP_DIR/"
          cp packages/ui/package.json "$TEMP_DIR/"
          cp packages/ui/README.md "$TEMP_DIR/" 2>/dev/null || true
          cp packages/ui/LICENSE "$TEMP_DIR/" 2>/dev/null || true

          # Create the tarball
          cd "$TEMP_DIR"
          npm pack
          mv *.tgz immich-ui.tgz

          # Switch to dist branch
          cd "$GITHUB_WORKSPACE"
          git fetch origin dist:dist 2>/dev/null || true

          if git show-ref --verify --quiet refs/heads/dist; then
            git checkout dist
          else
            git checkout --orphan dist
            git rm -rf .
          fi

          # Clear and copy new content
          rm -rf ./*
          cp -r "$TEMP_DIR"/* ./

          # Commit and push
          git add -A
          git diff --staged --quiet || git commit -m "Build from ${{ github.sha }}"
          git push origin dist --force
